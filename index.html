<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
    <title>Simplificando C√≥digo</title>

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="css/reveal.css">
		<!-- <link rel="stylesheet" href="css/theme/night.css" id="theme"> -->
		<link rel="stylesheet" href="css/theme/solarized.css" id="theme">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

    <style>
      body {
        /* green or 3F3*/
/*        background: #002;
        background-color: #002;*/
      }
      .reveal h1, .reveal h2 {
        white-space: nowrap;
      }
      .reveal section img {
        border: 0;
      }
      .reveal pre code {
        font-size: 2.7em;
        line-height: 1em;
        padding: 10px;
      }
    </style>

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">

<section>
  <h1>Simplificando<br>C√≥digo</h1>

  <p>Tute Costa</p>

  <p>https://github.com/tute/refactoring-workshop</p>
</section>

<section data-transition="none">
  <h1>Patrones de<br>Refactorizaci√≥n</h1>

  <aside class="notes">
    Un PATRON es una SOLUCI√ìN REUSABLE para un problema recurrente.<br>
    Los PATRONES son MEJORES PR√ÅCTICAS pulidos por una comunidad.
    Un PATRON es una DESCRIPCI√ìN de c√≥mo resolver un problema, que puede ser
    aplicada en distintas situaciones.

    <br><br>

    REFACTORIZAR es reestructurar c√≥digo sin cambiar su comportamiento visible.
    Ventajas son COMPLEJIDAD REDUCIDA, y mejor LEGIBILIDAD, facilitando el
    MANTENIMIENTO. Tambi√©n es √∫til para crear una arquitectura EXPRESIVA, con
    nuestros programas usando T√âRMINOS del MUNDO REAL, facilitando la
    COMUNICACI√ìN entre distintas personas.

    <br><br>

    Los patrones de refactorizaci√≥n, entonces, son...
  </aside>
</section>

<section>
  <h1>Vamos a ver</h1>
  <ul>
    <li>Tres anomal√≠as comunes en software
    <li>Patrones para refactorizarlas
  </ul>

  <aside class="notes">
    Los patrones permiten poner un l√≠mite sobre la cantidad de trabajo
  </aside>
</section>

<section data-transition="none">
  <h1>Vamos a ver</h1>

  <ol>
    <li>üëâ <span style="color: #f33">C√≥digo confuso</span><br><br>
    <li><span style=""><tt>"NoMethodError: Undefined method on nil"</tt></tt><br><br>
    <li><span style="">Un M√©todo Gigante</span>
  </ol>
</section>

<section data-transition="none">
  <h1>1: C√≥digo confuso</h1>

<pre><code data-trim contenteditable>
# Removes duplicates
if hash[row[1]][date] != row[0]
  # ... code ...
</code></pre>

  <aside class="notes" data-markdown>
    * Como un chiste: si hay que EXPLICARLO, es MALO

    * IDEA: Extraer CONCEPTOS relevantes como M√âTODOS bien nombrados
    * Una t√°ctica: convertir comentarios en C√ìDIGO EJECUTABLE
  </aside>
</section>

<section data-transition="none">
  <h1>1: C√≥digo confuso</h1>

<pre><code data-trim contenteditable>
# Removes duplicates
if hash[row[1]][date] != row[0]
  # ... code ...
</code></pre>

vs

<pre><code data-trim contenteditable>
if remove_duplicates?
  # ... code ...

def remove_duplicates?
  hash[row[1]][date] != row[0]
</code></pre>

  <aside class="notes" data-markdown>
    * Lo m√°s IMPORTANTE arriba
    * El c√≥digo se DESCRIBE a s√≠ mismo: hace lo que PENS√ÅS que hace
    * Puede ganar l√≠neas, pero tambi√©n legibilidad
    * Es m√°s "CORTO" de leer: no hay que entender c√≥mo se computan duplicados
    para inferir lo que hace
    * Conocen este PATR√ìN?
  </aside>
</section>

<section data-transition="none">
  <h1>M√©todo que revela<br>la intenci√≥n</h1>

  <p>Agregar <b>comentarios</b> si no tiene
  <p>Transformarlos en <b>c√≥digo</b>
  <p>Los <b>comentarios</b> son ahora <b>ejecutables</b>
  <p>El c√≥digo se <b>describe</b> a s√≠ mismo

</section>

<section>
  <img src="imgs/lets-work-rosie the riveter.jpg" width="500">
</section>

<section data-transition="none">
  <h2>
    Los comentarios son c√≥digo
    <br><br>
    El c√≥digo se describe a s√≠ mismo
  </h2>

  <br>

  <h1><span style="color: green">EXITO TOTAL</span><h1>

  <aside class="notes" data-markdown>
    El c√≥digo deber√≠a leerse como un art√≠culo de un diario, que va de lo m√°s importante a detalles de menor relevancia
  </aside>
</section>

<section data-transition="none">
  <h2>M√©todo que revela la intenci√≥n</h2>

  <p>Es el patr√≥n m√°s <b style="color: green">simple</b></p>

  <div class="fragment">
    <img src="imgs/naming.png">
    <p>Pero tambi√©n el m√°s <b style="color:#f33">dif√≠cil</b></p>
  </div>

  <aside class="notes" data-markdown>
    Parece el patr√≥n m√°s f√°cil (transformaciones sint√°cticas), pero es el m√°s dif√≠cil, porque implica NOMBRAR cosas

    Dos problemas GRANDES en Computaci√≥n: invalidar caches y poner nombres

    Y no s√≥lo nombrar, tambi√©n decidir niveles de ABSTRACCI√ìN:

    * ¬øQu√© cuenta como RESPONSABILIDAD DEL NEGOCIO y qu√© como mero DETALLE DE
    IMPLEMENTACI√ìN?
    * ¬øC√≥mo modelamos cosas del mundo real en c√≥digo en la computadora?
  </aside>
</section>

<section data-transition="none">
  <h2>M√©todo que revela la intenci√≥n</h2>

  <img src="imgs/lo-que-facilita-el-diseno.png" width="400">
  <br>
  El dise√±o puede prescindir de instrucciones

  <aside class="notes" data-markdown>
    No deber√≠a llevar mucho tiempo entender qu√© hace una secci√≥n de c√≥digo, porque ya demasiado confuso es trabajar con software como para adem√°s agregarle complejidad no indispensable

    Avdi Grimm lo llam√≥ "ofrecimientos" ("affordances"): qu√© facilita el dise√±o intuitivamente, sin necesidad de pensarlo
  </aside>
</section>

<section data-transition="none">
  <h1>Tests</h1>

  <p>Para cambiar c√≥digo sin cambiar comportamiento

  <h1>Gestor de versiones</h1>

  <p>Para abortar misi√≥n

  <aside class="notes" data-markdown>
    Dos prerequisitos

    Escribir c√≥digo y deshacerlo es TAN PRODUCTIVO COMO escribir c√≥digo y publicarlo, se aprende del Software y del mundo real tambi√©n
  </aside>
</section>

<section data-transition="none">
  <h1>Vamos a ver</h1>

  <ol>
    <li>C√≥digo confuso -> <span style="color: green">M√©todo que revela la intenci√≥n</span><br><br>
    <li>üëâ <span style="color: #f33"><tt>"NoMethodError: Undefined method on nil"</tt></tt><br><br>
    <li><span style="">Un M√©todo Gigante</span>
  </ol>
</section>

<section data-transition="none">
  <h1>Ey, nil! üëãüèº</h1>

<pre><code data-trim contenteditable>
current_user.name
</code></pre>

<pre><code data-trim contenteditable>
NoMethodError:
undefined method `name'
for nil:NilClass
</code></pre>

  <aside class="notes" data-markdown>
    El PROBLEMA es que en producci√≥n no sabemos exactamente d√≥nde fall√≥
  </aside>
</section>

<section data-transition="none">
  <h1>Ey, nil! üëãüèº</h1>

  <code style="color: #f33; font-size: 140%">Undefined method `name' for nil</code>

<pre><code data-trim contenteditable>
session[:user]      # nil
session[:blog_pozt] # nil
array[length + 1]   # nil
@current_uZer       # nil
if false then 1 end # nil
empty_method()      # nil
</code></pre>

<aside class="notes" data-markdown>
    Imaginen que reciben la excepci√≥n por mail.

    <br><br>

    De d√≥nde vino la excepci√≥n? De un art√≠culo sin foto? De un visitante que no
    se autentic√≥? De un error de tipeo al buscar en una cookie?

    <br><br>

    `nil` puede venir de:

    * un hash con `nil` como valor para una clave
    * un hash donde se busca con una clave inexistente
    * un arreglo indexado fuera de su rango
    * una variable de instancia inexistente
    * un condicional que eval√∫a a `false` pero no hay `else` definido
    * un m√©todo vac√≠o
  </aside>
</section>

<section data-transition="none">
  <h1>Ey, nil! üëãüèº</h1>

  <p>Un <span style="color:#0f0">s√≠mbolo</span> es mejor que <code style="color:#f33">nil</code>:</p>

<pre><code data-trim contenteditable>
def current_user
  User.find(id) || :guest_user
end
</code></pre>
<pre><code data-trim contenteditable>
current_user.name
</code></pre>

  <br>
  <code style="color: #0f0; font-size: 140%">undefined method `name' for :guest_user:Symbol</code>

  <aside class="notes" data-markdown>
    Ahora sabemos sin pensarlo el contexto en el que fall√≥

    En este caso esper√°bamos un usuario y no un producto o categor√≠a

    Pero seguimos necesitando `if`s en todos lados
  </aside>
</section>

<section data-transition="none">
  <h1>ifs por doquier</h1>

  <p>Donde pueda haber <code style="color:#f33">nil</code> hay que chequear con <code style="color:#f33">if</code></p>
  <pre><code data-trim contenteditable>
if user != :guest_user
  "Hi #{user.name}!"
else
  "Hi guest!"
end
  </code></pre>

  <aside class="notes">

    "Sab√©s el nombre o te tengo que decir lo que es?"

    <br><br>

    La l√≥gica sobre el significado de un visitante que no est√° autenticado se desparrama por toda el c√≥digo

    <br><br>

    Un cambio sobre esta l√≥gica tiene que ocurrir en todos los lugares donde aparezca (ejemplo, internacionalizaci√≥n)
    un cambio conceptual cambia muchos archivos diversos

    <br><br>

    Siempre nos queda alg√∫n condicional en el tintero, generando un error en producci√≥n

    <br><br>

    Entonces, ¬øqu√© hacemos?
  </aside>
</section>

<section data-transition="none">
  <p>En lugar de <code style="color:#f33">nil</code>, devolver un nuevo
    <span style="color:#0f0">objeto</span></p>

<pre class="fragment"><code data-trim contenteditable>
def user
  User.find(id) || NullUser.new
end
</code></pre>
<pre class="fragment"><code data-trim contenteditable>
class NullUser
  def name; 'guest'; end
end
</code></pre>
<div class="fragment">
Y eliminar condionales:
<pre><code data-trim contenteditable>
# if user
  "Hi #{user.name}!"
# else
#   "Hi guest!"
# end
</code></pre>
</div>

<aside class="notes" data-markdown>
Ahora necesitamos ese √∫nico condicional, escondido en el operador `or`
</aside>
</section>

<section>
  <img src="imgs/lets-work Melba Roy Mouton.jpg" width="500">
</section>

<section>
  <h2>Pero... ¬øporqu√©?</h2>
  <img class="fragment" src="imgs/1-kart.gif" width="500">
</section>
<section data-transition="none">
  <h2>Pero... ¬øporqu√©?</h2>
  <img src="imgs/3-graph.png" width="500">
</section>
<section data-transition="none">
  <h2>Pero... ¬øporqu√©?</h2>
  <table>
    <tr>
    <td><img src="imgs/2-747-cafe.png" width="500">
    <td><img class="fragment" src="imgs/2-747.jpg" width="500">
    </tr>
  </table>
</section>
<section data-transition="none">
  <h2>Pero... ¬øporqu√©?</h2>
  <img src="imgs/4-graph.png" width="500">
</section>
<section data-transition="none">
  <h2>Pero... ¬øporqu√©?</h2>
  <img src="imgs/5-graph.png" width="500">
</section>

<section data-transition="none">
  <h1>Vamos a ver</h1>

  <p>C√≥digo confuso -> <span style="color: green">M√©todo que revela la intenci√≥n</span>

  <p> <tt>"Undefined method on nil"</tt> -> <span style="color: green">Objecto Nulo</span><br>

  <p>üëâ <span style="color: #f33">Un M√©todo Gigante</span>
</section>

<section>
  <h1>M√©todo Gigante</h1>

  <pre><code data-trim contenteditable style="font-size:120%">
class ExportJob
  # Instance variables
  # Many other methods
  #
  # And...
  def self.row_per_day_format(file_name)
    file = File.open file_name, 'r:ISO-8859-1'
    # hash[NivelConsistencia][date] = [[value, status]]
    hash = { '1' => {}, '2' => {} }
    dates = []
    str = ''

    CSV.parse(file, col_sep: ';').each do |row|
      next if row.empty?
      next if row[0] =~ /^\/\//
      date = Date.parse(row[2])
      (13..43).each do |i|
        measurement_date = date + (i-13)

        # If NumDiasDeChuva is empty it means no data
        value  = row[7].nil? ? -99.9 : row[i]
        status = row[i + 31]
        hash_value = [value, status]

        dates << measurement_date
        hash[row[1]][measurement_date] = hash_value
      end
    end

    dates.uniq.each do |date|
      if !hash['1'][date].nil? && hash['2'][date].nil?
        # Only 'bruto' (good)
        value = hash['1'][date]
        str << "#{date}\t#{value[0]}\t#{value[1]}\n"
      elsif hash['1'][date].nil? && !hash['2'][date].nil?
        # Only 'consistido' (kind of good)
        value = hash['2'][date]
        str << "#{date}\t#{value[0]}\t#{value[1]}\n"
      else
        # 'bruto' y 'consistido' (has new and old data)
        old_value = hash['1'][date]
        new_value = hash['2'][date]
        str << "#{date}\t#{new_value[0]}\t#{old_value[1]}\t#{old_value[0]}\n"
      end
    end

    str
  end
  </code></pre>

  <aside class="notes" data-markdown>
    La ansiedad del "por d√≥nde empiezo". El m√©todo tiene variables y distintas piezas de l√≥gica, todas MEZCLADAS en un MISMO CONTEXTO

    Hay mucho ACOPLAMIENTO: cualquier cambio REPERCUTE en el m√©todo y potencialmente en su clase contenedora, que tambi√©n es grande.

    Si aplicamos "M√©todo que revela la intenci√≥n" tendremos:

    * MUCHOS m√©todos en la clase, potencialmente colisionando con otros de similar nombre
    * M√©todos que requieren MUCHOS ARGUMENTOS (no vamos a polucionar el objeto con variables de instancia para lo que en verdad son variables locales)
    * El riesgo de un sistema con tests fallando por demasiado tiempo, no pudiendo nunca cerrar el refactor

    Es dif√≠cil TIRAR DE UN HILO sin desarmar el pa√±o entero

    Hay mucho CONTEXTO COMPARTIDO, hay que aislar el gran m√©todo para que los cambios que apliquemos repercutan S√ìLO en ese m√©todo

    <br><br>

    ¬øQu√© hacemos?

  </aside>
</section>

<section>
  <h1>Extraer Objeto</h1>

  <ol>
    <li>Crear una <span style="color:#0f0">clase</span> que reciba los mismos argumentos del m√©todo
    <li>Copiar y pegar el <span style="color:#0f0">m√©todo</span> en la nueva clase vac√≠a
    <li><span style="color:#0f0">Reemplazar</span> el m√©todo original con una llamada a la nueva clase
    <li>Aplicar "<span style="color:#0f0">m√©todo que revela la intenci√≥n</span>" sobre la nueva clase
  </ol>
</section>

<section>
  <img src="imgs/lets-work-eniac-women-1940s-720x720.jpg" width="720">
</section>

<section data-transition="none">
  <h1>Therapeutic<br>Refactoring</h1>

  <h3>Katrina Owens</h3>

  <p>
    <a target="_blank" href="http://confreaks.com/videos/1071-cascadiaruby2012-therapeutic-refactoring">http://confreaks.com/videos/1071-cascadiaruby2012-therapeutic-refactoring</a>
  </p>
</section>

<section data-transition="none">
  <h1>Pr√≥ximos pasos</h1>

  <h3><a target="_blank" href="http://robots.thoughtbot.com/sandi-metz-rules-for-developers">Las 4 reglas</a></h3>

  <p>Clases de <span style="color:#0f0">100 l√≠neas</span> o menos
  <p>M√©todos de <span style="color:#0f0">5 l√≠neas</span> o menos
  <p>M√©todos con <span style="color:#0f0">4 argumentos</span> o menos
  <p>Un controlador instancia <span style="color:#0f0">s√≥lo un objeto</span>

  <aside class="notes">
    <p>Hay docenas de patrones de dise√±o y de refactoring, hay muchas m√©tricas de calidad para software

    <p>Son reglas simples para explicar y entender, e implican muchas buenas pr√°cticas

    <p>Estas reglas llevan naturalmente a respetar esos patrones y m√©tricas, sin necesidad de saber nombrarlas como ni√±o dando la lecci√≥n

    <p>Siguiendo estas simples reglas van a ir a buenos puertos

    <p>Cu√°nto refactorizar: until-you-feel-almost-comfortable
  </aside>
</section>


<section data-transition="none">
  <h1>Vimos</h1>

  <p>C√≥digo confuso -> <span style="color: green">M√©todo que revela la intenci√≥n</span>

  <p> <tt>"Undefined method on nil"</tt> -> <span style="color: green">Objecto Nulo</span><br>

  <p>Un M√©todo Gigante -> <span style="color: green">Reemplazar con "Method Object"</span>
</section>

<section data-transition="none">
  <h1>Preguntas!</h1>

  <p>tutecosta@gmail.com - https://github.com/tute</p>
  <p>
    <small>Principal Engineer at</small>
    <br>
    EpionHealth.com
  </p>

  <img src="imgs/eh.png" width="600">

  <div class="fragment">
    <tt>nil</tt> ü§ì
  </div>

  <aside class="notes" data-markdown>
    Soy Tute Costa, trabajo remotamente para Epion Health, una empresa relacionada a la Salud de Estados Unidos.

    Nuestra aplicaci√≥n "check in" permite a pacientes completar los formularios m√©dicos necesarios antes de ver a su m√©dico, de manera simple y r√°pida desde un iPad o desde sus tel√©fonos.

    Procesamos 30.000 check-ins por d√≠a, y somos buenos amigos con `nil` desde que empez√≥ el proyecto, 7 a√±os atr√°s (2015). La empresa est√° creciendo as√≠ que hay diversi√≥n para rato.
  </aside>
</section>

			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});
		</script>

	</body>
</html>
